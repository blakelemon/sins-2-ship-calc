<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sins of a Solar Empire 2 Ship Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-image: url("https://www.stardock.com/sinsofasolarempire/sinsofasolarempire2/press/sins-screenshots/steamrelease/sins2_steamrelease_05.jpg");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e0e0e0;
        }
        
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        .glassmorphism {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            margin-bottom: 20px;
        }

        .collapsible {
            background-color: rgba(99, 102, 241, 0.2);
            color: #ffffff;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
            border-radius: 5px;
        }

        .active, .collapsible:hover {
            background-color: rgba(99, 102, 241, 0.4);
        }

        .content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .content.show {
            max-height: 1000px; /* Adjust this value as needed */
        }

        .efficiency-bar {
            height: 20px;
            background-color: #4CAF50;
            text-align: right;
            color: white;
            font-size: 12px;
            line-height: 20px;
            padding-right: 5px;
        }

        .ship-group {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .ship-details {
            display: none;
        }

        .show-details {
            background-color: rgba(99, 102, 241, 0.2);
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
        }

        .show-details:hover {
            background-color: rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold mb-8 text-center text-indigo-300 drop-shadow-lg">Sins of a Solar Empire 2 Ship Calculator</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="glassmorphism p-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-200">Attackers</h2>
                <div id="attackerContainer"></div>
                <button id="addAttacker" class="w-full p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors">Add Attacker Ship</button>
            </div>
            
            <div class="glassmorphism p-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-200">Defenders</h2>
                <div id="defenderContainer"></div>
                <button id="addDefender" class="w-full p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors">Add Defender Ship</button>
            </div>
        </div>
        
        <div class="mt-8 glassmorphism p-6">
            <button class="collapsible mb-4 w-full p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors">Global Modifiers</button>
            <div class="content mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-indigo-200">Attacker Modifiers</h3>
                        <input type="number" id="attackerHullMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Hull Modifier (%)" min="0">
                        <input type="number" id="attackerShieldMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Shield Modifier (%)" min="0">
                        <input type="number" id="attackerDamageMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Damage Modifier (%)" min="0">
                        <input type="number" id="attackerArmorStrengthMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Additional Armor Strength" min="0">
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-2 text-indigo-200">Defender Modifiers</h3>
                        <input type="number" id="defenderHullMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Hull Modifier (%)" min="0">
                        <input type="number" id="defenderShieldMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Shield Modifier (%)" min="0">
                        <input type="number" id="defenderDamageMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Damage Modifier (%)" min="0">
                        <input type="number" id="defenderArmorStrengthMod" class="w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Additional Armor Strength" min="0">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 glassmorphism p-6">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-200">Battle Results</h2>
            <div class="flex justify-between mb-4">
                <button id="calculateDamage" class="w-1/2 p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors mr-2">Calculate Damage</button>
                <button id="swapSides" class="w-1/2 p-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors ml-2">Swap Sides</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="battle-overview glassmorphism p-4">
                    <h3 class="text-xl font-semibold mb-3 text-indigo-300">Battle Overview</h3>
                    <div id="battleOverview" class="text-indigo-100"></div>
                </div>
                <div class="damage-calculation glassmorphism p-4">
                    <h3 class="text-xl font-semibold mb-3 text-indigo-300">Damage Calculation</h3>
                    <div id="damageOutput" class="text-indigo-100"></div>
                </div>
            </div>
            <div class="mt-6 glassmorphism p-4">
                <h3 class="text-xl font-semibold mb-3 text-indigo-300">Detailed Battle Statistics</h3>
                <div id="battleStats" class="text-indigo-100"></div>
            </div>
            <div class="mt-6 glassmorphism p-4">
                <h3 class="text-xl font-semibold mb-3 text-indigo-300">Research Bonuses</h3>
                <div id="researchBonus" class="text-indigo-100"></div>
            </div>
        </div>
    </div>

    <script>
        let shipData = [];

        async function loadShipData() {
            try {
                const response = await fetch('assets/sins_data.json');
                const jsonData = await response.json();
                shipData = Object.entries(jsonData).map(([shipName, shipStats]) => {
                    return {
                        Ship: shipName,
                        ...shipStats
                    };
                });
                console.log('Loaded ship data:', shipData);
                setupShipGroups('attacker');
                setupShipGroups('defender');
            } catch (error) {
                console.error('Error loading ship data:', error);
            }
        }

        function calculateEffectiveDPS(attackerShip, defenderShip, damageMod, additionalArmorStrength) {
            let totalEffectiveDPS = 0;
            for (let i = 1; i <= 6; i++) {
                const damage = attackerShip[`Damage_${i}`] * damageMod;
                const pen = attackerShip[`Pen_${i}`];
                const dps = attackerShip[`DPS_${i}`] * damageMod;

                if (damage && pen !== undefined && dps) {
                    const effectiveDurability = Math.max(0, defenderShip.Durability - pen);
                    const durabilityMultiplier = 100 / (100 + effectiveDurability);
                    const armorStrengthMultiplier = 100 / (100 + defenderShip.Armor_Strength + additionalArmorStrength);
                    const effectiveArmor = defenderShip.Armor * (1 + (defenderShip.Armor_Strength + additionalArmorStrength) / 100);
                    const damageToArmor = Math.min(damage * durabilityMultiplier, effectiveArmor);
                    const damageToHull = Math.max(0, (damage * durabilityMultiplier) - effectiveArmor);
                    const effectiveDamage = (damageToArmor + damageToHull);
                    totalEffectiveDPS += (effectiveDamage / attackerShip[`Gun_CD_${i}`]);
                }
            }
            return totalEffectiveDPS;
        }

        const allowedShips = [
            "Vas_Scout", "Vas_Raider", "Vas_Defensor", "Vas_LF", "Vas_LRF", "Vas_HC", "Vas_Carrier", "Vas_Penetrator",
            "Adv_Corvette", "Adv_LF", "Adv_Tempests", "Adv_Flak", "Adv_LRF", "Adv_HC", "Adv_Carrier",
            "TEC_Corvette", "TEC_LF", "TEC_Flak", "TEC_Kalve", "TEC_LRF", "TEC_HC", "TEC_Carrier", "TEC_Orgrov",
            "Pirate_LF", "Pirate_Siege", "Pirate_HC",
            "Vas_Kortul", "Vas_EGG", "Vas_Skirantra", "Vas_Marauder", "Vas_Vulkoras", "Vas_Vorastra", "Vas_Kultorask",
            "Adv_Radiance", "Adv_Progen", "Adv_Halcyon", "Adv_Rapture", "Adv_Revelation", "Adv_Eradica", "Adv_Coronata",
            "TEC_Kol", "TEC_Akkan", "TEC_Dunov", "TEC_Sova", "TEC_Marza", "TEC_Ankylon", "TEC_Ragnarov",
            "TEC_Turret", "TEC_Gauss_Turret", "TEC_Hangar", "Adv_Turret", "Adv_Beam_Turret", "Adv_Hangar",
            "Vas_Turret", "Vas_Missile_Turret", "TEC_Starbase", "Adv_Starbase", "Vas_Starbase"
        ];

        function populateShipSelects() {
            const attackerContainer = document.getElementById('attackerContainer');
            const defenderContainer = document.getElementById('defenderContainer');
            
            populateShipSelect(attackerContainer.querySelector('.ship1'));
            populateShipSelect(defenderContainer.querySelector('.ship2'));
        }

        function populateShipSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Select Ship</option>';
            shipData.forEach(ship => {
                const option = new Option(ship.Ship, ship.Ship);
                selectElement.add(option);
            });
        }

        function calculateShipCost(ship) {
            const metalCost = ship.Metal * 2;
            const crystalCost = ship.Crystal * 3;
            const totalCost = ship.Credits + metalCost + crystalCost;
            const costWith21 = ship.Credits + ship.Metal * 2 + ship.Crystal * 2;
            return {
                credits: ship.Credits,
                metal: ship.Metal,
                crystal: ship.Crystal,
                total: totalCost,
                costWith21: costWith21
            };
        }


        function updateShipDetails(shipElement, detailsElement) {
            const ship = shipData.find(s => s.Ship === shipElement.value);
        
            if (ship) {
                const cost = calculateShipCost(ship);
                const totalDPS = ship.Total_DPS || 0;
                const additionalEHP = ship.Armor * (ship.Armor_Strength / 100);
        
                detailsElement.innerHTML = `
                    <p><strong>Supply:</strong> ${ship.Supply}</p>
                    <p><strong>Total DPS:</strong> ${totalDPS}</p>
                    <p><strong>Total HP:</strong> ${ship['Total Health']}</p>
                    <button class="show-details">Show More Details</button>
                    <div class="ship-details">
                        <button class="collapsible">Health Information</button>
                        <div class="content">
                            <p><strong>Hull:</strong> ${ship.Hull} (Heal: ${ship.Hull_Heal}/s)</p>
                            <p><strong>Armor:</strong> ${ship.Armor} (Strength: ${ship.Armor_Strength}%)</p>
                            <p><strong>Shields:</strong> ${ship.Shields} (Heal: ${ship.Shields_Heal}/s)</p>
                            <p><strong>Total Health:</strong> ${ship['Total Health']}</p>
                            <p><strong>Health at 0 Pen:</strong> ${ship['Health at 0 Pen']}</p>
                            <p><strong>Additional EHP from Armor:</strong> ${additionalEHP.toFixed(2)}</p>
                            <p><strong>Durability:</strong> ${ship.Durability}</p>
                        </div>

                        <button class="collapsible">Cost Information</button>
                        <div class="content">
                            <p><strong>Credits:</strong> ${cost.credits}</p>
                            <p><strong>Metal:</strong> ${cost.metal}</p>
                            <p><strong>Crystal:</strong> ${cost.crystal}</p>
                            <p><strong>Total Cost (3:1 Crystal):</strong> ${cost.total}</p>
                            <p><strong>Total Cost (2:1 Crystal):</strong> ${cost.costWith21}</p>
                            <p><strong>Build Time:</strong> ${ship['Build time']} seconds</p>
                            <p><strong>XP:</strong> ${ship.XP}</p>
                        </div>

                        <button class="collapsible">Weapon Information</button>
                        <div class="content">
                            ${[1, 2, 3, 4, 5, 6].map(i => 
                                ship[`Damage_${i}`] && ship[`Pen_${i}`] && ship[`Gun_CD_${i}`] && ship[`DPS_${i}`] ?
                                `<h4 class="font-semibold mt-2">Weapon ${i}</h4>
                                <p><strong>Damage Per Volley:</strong> ${ship[`Damage_${i}`]}</p>
                                <p><strong>Weapon Pierce:</strong> ${ship[`Pen_${i}`]}</p>
                                <p><strong>Weapon Fire Time:</strong> ${ship[`Gun_CD_${i}`]} seconds</p>
                                <p><strong>Weapon DPS:</strong> ${ship[`DPS_${i}`]}</p>` : ''
                            ).join('')}
                            ${ship['Bomber Dmg'] ? 
                                `<h4 class="font-semibold mt-2">Bomber</h4>
                                <p><strong>Damage:</strong> ${ship['Bomber Dmg']}</p>
                                <p><strong>Pierce:</strong> ${ship['Bomber Pen']}</p>
                                <p><strong>Cooldown:</strong> ${ship['Bomber CD']} seconds</p>
                                <p><strong>DPS:</strong> ${ship['Bomber DPS']}</p>` : ''}
                            ${ship['Fighter Dmg'] ? 
                                `<h4 class="font-semibold mt-2">Fighter</h4>
                                <p><strong>Damage:</strong> ${ship['Fighter Dmg']}</p>
                                <p><strong>Pierce:</strong> ${ship['Fighter Pen']}</p>
                                <p><strong>Cooldown:</strong> ${ship['Fighter CD']} seconds</p>
                                <p><strong>DPS:</strong> ${ship['Fighter DPS']}</p>` : ''}
                        </div>

                        <button class="collapsible">Efficiency Metrics</button>
                        <div class="content">
                            <p><strong>DPS per Supply:</strong> ${ship['DPS per Supply']}</p>
                            <p><strong>HP per Credit (1:2):</strong> ${ship['HP per Credit 1:2']}</p>
                            <p><strong>HP per Credit (1:3):</strong> ${ship['HP per Credit 1:3']}</p>
                            <p><strong>HP per Credit (Crystal Heavy):</strong> ${ship['HP per Credit Crystal Heavy']}</p>
                        </div>
                    </div>
                `;

                // Add event listeners to collapsible elements
                detailsElement.querySelectorAll(".collapsible").forEach(coll => {
                    coll.addEventListener("click", function() {
                        this.classList.toggle("active");
                        const content = this.nextElementSibling;
                        if (content.style.maxHeight){
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                });

                // Add event listener to show more details button
                detailsElement.querySelector(".show-details").addEventListener("click", function() {
                    const shipDetails = this.nextElementSibling;
                    if (shipDetails.style.display === "none" || shipDetails.style.display === "") {
                        shipDetails.style.display = "block";
                        this.textContent = "Hide Details";
                    } else {
                        shipDetails.style.display = "none";
                        this.textContent = "Show More Details";
                    }
                });
            } else {
                detailsElement.innerHTML = "<p>No ship data found.</p>";
            }
        }




        function calculateEffectiveHealth(ships, enemyDamageMod, ownArmorStrengthMod) {
            return ships.reduce((total, { ship, count }) => {
                const effectiveArmor = ship.Armor * (1 + (ship.Armor_Strength + ownArmorStrengthMod) / 100);
                const effectiveHealth = (ship.Hull + effectiveArmor + ship.Shields) * count;
                return total + effectiveHealth;
            }, 0);
        }

        function calculateDamage() {
            const attackerHullMod = 1 + (parseFloat(document.getElementById('attackerHullMod').value) || 0) / 100;
            const attackerShieldMod = 1 + (parseFloat(document.getElementById('attackerShieldMod').value) || 0) / 100;
            const attackerDamageMod = 1 + (parseFloat(document.getElementById('attackerDamageMod').value) || 0) / 100;
            const attackerArmorStrengthMod = parseFloat(document.getElementById('attackerArmorStrengthMod').value) || 0;

            const defenderHullMod = 1 + (parseFloat(document.getElementById('defenderHullMod').value) || 0) / 100;
            const defenderShieldMod = 1 + (parseFloat(document.getElementById('defenderShieldMod').value) || 0) / 100;
            const defenderDamageMod = 1 + (parseFloat(document.getElementById('defenderDamageMod').value) || 0) / 100;
            const defenderArmorStrengthMod = parseFloat(document.getElementById('defenderArmorStrengthMod').value) || 0;

            const attackers = Array.from(document.querySelectorAll('.attacker-group')).map(group => ({
                ship: shipData.find(s => s.Ship === group.querySelector('.ship1').value),
                count: parseInt(group.querySelector('.ship1Count').value) || 1
            })).filter(a => a.ship);

            const defenders = Array.from(document.querySelectorAll('.defender-group')).map(group => ({
                ship: shipData.find(s => s.Ship === group.querySelector('.ship2').value),
                count: parseInt(group.querySelector('.ship2Count').value) || 1
            })).filter(d => d.ship);

            if (attackers.length > 0 && defenders.length > 0) {
                const damageOutputElement = document.getElementById('damageOutput');
                const timeToKill = document.getElementById('timeToKill');
                let totalDamage = 0;
                let damageBreakdown = '';
                let totalDefenderHealth = 0;
                let totalDefenderSupply = 0;
                let totalDefenderCost = 0;
                let totalAttackerSupply = 0;
                let totalAttackerCost = 0;
                let totalAttackerDPS = 0;
                let totalDefenderDPS = 0;

                attackers.forEach((attacker, attackerIndex) => {
                    const attackerCost = calculateShipCost(attacker.ship);
                    totalAttackerSupply += attacker.ship.Supply * attacker.count;
                    totalAttackerCost += attackerCost.total * attacker.count;
                    totalAttackerDPS += (attacker.ship.Total_DPS || 0) * attacker.count * attackerDamageMod;

                    defenders.forEach((defender, defenderIndex) => {
                        if (attackerIndex === 0) {
                            const defenderCost = calculateShipCost(defender.ship);
                            const modifiedDefenderHealth = 
                                defender.ship.Hull * defenderHullMod + 
                                defender.ship.Shields * defenderShieldMod + 
                                defender.ship.Armor * (1 + (defender.ship.Armor_Strength + defenderArmorStrengthMod) / 100);
                            totalDefenderHealth += modifiedDefenderHealth * defender.count;
                            totalDefenderSupply += defender.ship.Supply * defender.count;
                            totalDefenderCost += defenderCost.total * defender.count;
                            totalDefenderDPS += (defender.ship.Total_DPS || 0) * defender.count * defenderDamageMod;
                        }

                        for (let i = 1; i <= 6; i++) {
                            const damage = attacker.ship[`Damage_${i}`] * attackerDamageMod;
                            const pen = attacker.ship[`Pen_${i}`];
                            const dps = attacker.ship[`DPS_${i}`] * attackerDamageMod;

                            if (damage && pen !== undefined && dps) {
                                const effectiveDurability = Math.max(0, defender.ship.Durability - pen);
                                const durabilityMultiplier = 100 / (100 + effectiveDurability);
                                const armorStrengthMultiplier = 100 / (100 + defender.ship.Armor_Strength + defenderArmorStrengthMod);
                                const effectiveArmor = defender.ship.Armor * (1 + (defender.ship.Armor_Strength + defenderArmorStrengthMod) / 100);
                                const damageToArmor = Math.min(damage * durabilityMultiplier, effectiveArmor);
                                const damageToHull = Math.max(0, (damage * durabilityMultiplier) - effectiveArmor);
                                const effectiveDamage = (damageToArmor + damageToHull) * attacker.count;
                                totalDamage += effectiveDamage;

                                const additionalEHP = effectiveArmor - defender.ship.Armor;
                                const pierceEffectiveness = (defender.ship.Durability > 0) ? 
                                    Math.min(100, (pen / defender.ship.Durability * 100)) : 100;

                                damageBreakdown += `
                                    <div class="mb-4 p-4 bg-indigo-800 rounded">
                                        <h4 class="font-semibold text-lg mb-2">Attacker ${attackerIndex + 1} Weapon ${i} vs Defender ${defenderIndex + 1}:</h4>
                                        <p><strong>Total Damage:</strong> ${effectiveDamage.toFixed(2)}</p>
                                        <p><strong>Damage to Armor:</strong> ${damageToArmor.toFixed(2)}</p>
                                        <p><strong>Damage to Hull:</strong> ${damageToHull.toFixed(2)}</p>
                                        <p><strong>Pierce Effectiveness:</strong> ${pierceEffectiveness.toFixed(2)}%</p>
                                        <p><strong>Durability Efficiency:</strong> ${(durabilityMultiplier * 100).toFixed(2)}%</p>
                                        <p><strong>Additional EHP from Armor:</strong> ${additionalEHP.toFixed(2)}</p>
                                    </div>
                                `;
                            }
                        }
                    });

                    const attackerDPS = Object.keys(attacker.ship)
                        .filter(key => key.startsWith('DPS_') && attacker.ship[key])
                        .reduce((sum, key) => sum + attacker.ship[key], 0) * attacker.count * attackerDamageMod;
                    totalAttackerDPS += attackerDPS;
                });

                const timeToKillValue = totalDefenderHealth / totalAttackerDPS;
                const dpsPerSupply = totalAttackerDPS / totalAttackerSupply;

                const battleOverview = document.getElementById('battleOverview');
                const battleStats = document.getElementById('battleStats');
                const damageOutput = document.getElementById('damageOutput');
                const researchBonus = document.getElementById('researchBonus');

                // Calculate effective health pools
                const effectiveAttackerHealth = calculateEffectiveHealth(attackers, defenderDamageMod, attackerArmorStrengthMod);
                const effectiveDefenderHealth = calculateEffectiveHealth(defenders, attackerDamageMod, defenderArmorStrengthMod);

                // Battle Overview
                battleOverview.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-center">
                            <h4 class="font-semibold">Attackers</h4>
                            <p class="text-2xl font-bold">${totalAttackerSupply}</p>
                            <p class="text-sm">Supply</p>
                        </div>
                        <div class="text-center">
                            <h4 class="font-semibold">VS</h4>
                            <p class="text-2xl font-bold">${timeToKillValue.toFixed(2)}s</p>
                            <p class="text-sm">Time to Kill</p>
                        </div>
                        <div class="text-center">
                            <h4 class="font-semibold">Defenders</h4>
                            <p class="text-2xl font-bold">${totalDefenderSupply}</p>
                            <p class="text-sm">Supply</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold">Attacker Strength</h4>
                            <p class="text-lg">${totalAttackerDPS.toFixed(2)} DPS</p>
                            <p class="text-sm">Effective Health: ${effectiveAttackerHealth.toFixed(2)} HP</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Defender Strength</h4>
                            <p class="text-lg">${totalDefenderDPS.toFixed(2)} DPS</p>
                            <p class="text-sm">Effective Health: ${effectiveDefenderHealth.toFixed(2)} HP</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">DPS vs Effective Health Comparison</h4>
                        <p>Attackers will deplete Defenders' health in: ${(effectiveDefenderHealth / totalAttackerDPS).toFixed(2)}s</p>
                        <p>Defenders will deplete Attackers' health in: ${(effectiveAttackerHealth / totalDefenderDPS).toFixed(2)}s</p>
                    </div>
                `;

                // Damage Output
                damageOutput.innerHTML = `
                    <p class="text-lg mb-2"><strong>Total Damage per volley:</strong> ${totalDamage.toFixed(2)}</p>
                    <div class="mt-4 max-h-60 overflow-y-auto">
                        <h4 class="font-semibold mb-2">Damage Breakdown:</h4>
                        ${damageBreakdown}
                    </div>
                `;

                // Calculate effective DPS
                let totalEffectiveAttackerDPS = 0;
                let totalEffectiveDefenderDPS = 0;

                attackers.forEach(attacker => {
                    defenders.forEach(defender => {
                        const effectiveDPS = calculateEffectiveDPS(attacker.ship, defender.ship, attackerDamageMod, defenderArmorStrengthMod);
                        totalEffectiveAttackerDPS += effectiveDPS * attacker.count;
                    });
                });

                defenders.forEach(defender => {
                    attackers.forEach(attacker => {
                        const effectiveDPS = calculateEffectiveDPS(defender.ship, attacker.ship, defenderDamageMod, attackerArmorStrengthMod);
                        totalEffectiveDefenderDPS += effectiveDPS * defender.count;
                    });
                });

                const averageEffectiveAttackerDPS = totalEffectiveAttackerDPS / defenders.length;
                const averageEffectiveDefenderDPS = totalEffectiveDefenderDPS / attackers.length;

                // Detailed Battle Statistics
                battleStats.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-indigo-800 p-4 rounded-lg shadow-md">
                            <h4 class="font-semibold text-xl mb-4 text-indigo-200">Attacker Statistics</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="col-span-2 bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">DPS</p>
                                    <p>Raw Total: <span class="text-green-400">${totalAttackerDPS.toFixed(2)}</span></p>
                                    <p>Effective Avg: <span class="text-green-400">${averageEffectiveAttackerDPS.toFixed(2)}</span></p>
                                </div>
                                <div class="bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Supply</p>
                                    <p>Total: <span class="text-green-400">${totalAttackerSupply}</span></p>
                                </div>
                                <div class="bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Cost</p>
                                    <p>Total: <span class="text-green-400">${totalAttackerCost.toFixed(2)}</span> credits</p>
                                </div>
                                <div class="col-span-2 bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Efficiency (per Supply)</p>
                                    <p>Raw DPS: <span class="text-green-400">${(totalAttackerDPS / totalAttackerSupply).toFixed(2)}</span></p>
                                    <p>Effective DPS: <span class="text-green-400">${(averageEffectiveAttackerDPS / totalAttackerSupply).toFixed(2)}</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-indigo-800 p-4 rounded-lg shadow-md">
                            <h4 class="font-semibold text-xl mb-4 text-indigo-200">Defender Statistics</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="col-span-2 bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Health & DPS</p>
                                    <p>Total Health: <span class="text-green-400">${totalDefenderHealth.toFixed(2)}</span></p>
                                    <p>Raw Total DPS: <span class="text-green-400">${totalDefenderDPS.toFixed(2)}</span></p>
                                    <p>Effective Avg DPS: <span class="text-green-400">${averageEffectiveDefenderDPS.toFixed(2)}</span></p>
                                </div>
                                <div class="bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Supply</p>
                                    <p>Total: <span class="text-green-400">${totalDefenderSupply}</span></p>
                                </div>
                                <div class="bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Cost</p>
                                    <p>Total: <span class="text-green-400">${totalDefenderCost.toFixed(2)}</span> credits</p>
                                </div>
                                <div class="col-span-2 bg-indigo-700 p-2 rounded">
                                    <p class="font-semibold">Efficiency (per Supply)</p>
                                    <p>HP: <span class="text-green-400">${(totalDefenderHealth / totalDefenderSupply).toFixed(2)}</span></p>
                                    <p>Raw DPS: <span class="text-green-400">${(totalDefenderDPS / totalDefenderSupply).toFixed(2)}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 bg-indigo-800 p-4 rounded-lg shadow-md">
                        <h4 class="font-semibold text-xl mb-4 text-indigo-200">Efficiency Metrics</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-indigo-700 p-2 rounded">
                                <p class="font-semibold">Attacker Efficiency (per credit)</p>
                                <p>Raw DPS: <span class="text-green-400">${(totalAttackerDPS / totalAttackerCost).toFixed(4)}</span></p>
                                <p>Effective DPS: <span class="text-green-400">${(averageEffectiveAttackerDPS / totalAttackerCost).toFixed(4)}</span></p>
                            </div>
                            <div class="bg-indigo-700 p-2 rounded">
                                <p class="font-semibold">Defender Efficiency (per credit)</p>
                                <p>Raw DPS: <span class="text-green-400">${(totalDefenderDPS / totalDefenderCost).toFixed(4)}</span></p>
                                <p>Effective DPS: <span class="text-green-400">${(averageEffectiveDefenderDPS / totalDefenderCost).toFixed(4)}</span></p>
                                <p>HP: <span class="text-green-400">${(totalDefenderHealth / totalDefenderCost).toFixed(4)}</span></p>
                            </div>
                        </div>
                    </div>
                `;

                // Research Bonus
                researchBonus.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2">Attackers:</h4>
                            <p><strong>Hull Modifier:</strong> <span class="text-green-400">+${((attackerHullMod - 1) * 100).toFixed(2)}%</span></p>
                            <p><strong>Shield Modifier:</strong> <span class="text-green-400">+${((attackerShieldMod - 1) * 100).toFixed(2)}%</span></p>
                            <p><strong>Damage Modifier:</strong> <span class="text-green-400">+${((attackerDamageMod - 1) * 100).toFixed(2)}%</span></p>
                            <p><strong>Additional Armor Strength:</strong> <span class="text-green-400">+${attackerArmorStrengthMod}</span></p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">Defenders:</h4>
                            <p><strong>Hull Modifier:</strong> <span class="text-green-400">+${((defenderHullMod - 1) * 100).toFixed(2)}%</span></p>
                            <p><strong>Shield Modifier:</strong> <span class="text-green-400">+${((defenderShieldMod - 1) * 100).toFixed(2)}%</span></p>
                            <p><strong>Damage Modifier:</strong> <span class="text-green-400">+${((defenderDamageMod - 1) * 100).toFixed(2)}%</span></p>
                            <p><strong>Additional Armor Strength:</strong> <span class="text-green-400">+${defenderArmorStrengthMod}</span></p>
                        </div>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM content loaded');
            await loadShipData();
            console.log('Ship data loaded');

            document.getElementById('addAttacker').addEventListener('click', () => {
                addShipGroup('attacker');
            });

            document.getElementById('addDefender').addEventListener('click', () => {
                addShipGroup('defender');
            });

            // Initial setup for the first attacker and defender
            addShipGroup('attacker');
            addShipGroup('defender');

            // Setup ship groups after data is loaded
            setupShipGroups('attacker');
            setupShipGroups('defender');

            // Add event listener for the calculate damage button
            document.getElementById('calculateDamage').addEventListener('click', calculateDamage);

            document.getElementById('swapSides').addEventListener('click', swapSides);

            // Add event listeners for new collapsible elements
            document.addEventListener('click', function(e) {
                if (e.target && e.target.className.includes('collapsible')) {
                    e.target.classList.toggle("active");
                    const content = e.target.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                }
            });

            console.log('Setup complete');
        });

        function swapSides() {
            const attackerContainer = document.getElementById('attackerContainer');
            const defenderContainer = document.getElementById('defenderContainer');
            
            // Store the current state
            const attackerState = getContainerState(attackerContainer);
            const defenderState = getContainerState(defenderContainer);
            
            // Clear both containers
            attackerContainer.innerHTML = '';
            defenderContainer.innerHTML = '';
            
            // Rebuild containers with swapped state
            rebuildContainer(attackerContainer, defenderState, 'attacker');
            rebuildContainer(defenderContainer, attackerState, 'defender');

            // Swap global modifier values
            ['HullMod', 'ShieldMod', 'DamageMod', 'ArmorStrengthMod'].forEach(mod => {
                const attackerMod = document.getElementById(`attacker${mod}`);
                const defenderMod = document.getElementById(`defender${mod}`);
                const tempValue = attackerMod.value;
                attackerMod.value = defenderMod.value;
                defenderMod.value = tempValue;
            });

            // Update group info for both sides
            updateGroupInfo('attacker');
            updateGroupInfo('defender');

            // Automatically recalculate after swapping
            calculateDamage();
        }

        function getContainerState(container) {
            return Array.from(container.querySelectorAll('.attacker-group, .defender-group')).map(group => ({
                shipType: group.querySelector('select').value,
                count: group.querySelector('input[type="number"]').value
            }));
        }

        function rebuildContainer(container, state, newType) {
            state.forEach(item => {
                const newGroup = document.createElement('div');
                newGroup.className = `${newType}-group mb-4`;
                newGroup.innerHTML = `
                    <select class="ship${newType === 'attacker' ? '1' : '2'} w-full p-2 mb-2 border rounded custom-select bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="">Select ${newType.charAt(0).toUpperCase() + newType.slice(1)} Ship</option>
                    </select>
                    <input type="number" class="ship${newType === 'attacker' ? '1' : '2'}Count w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" value="${item.count}" min="1" placeholder="Number of Ships">
                    <div class="ship${newType === 'attacker' ? '1' : '2'}Details mb-2 text-indigo-100"></div>
                `;
                container.appendChild(newGroup);
                setupShipGroup(newGroup, newType);
                
                // Set the selected ship and update details
                const select = newGroup.querySelector('select');
                select.value = item.shipType;
                select.dispatchEvent(new Event('change'));
            });
        }

        function setupShipGroups(type) {
            const container = document.getElementById(`${type}Container`);
            const groups = container.querySelectorAll(`.${type}-group`);
            groups.forEach(group => {
                setupShipGroup(group, type);
                // Trigger change event to update ship details and group info
                const select = group.querySelector('select');
                select.dispatchEvent(new Event('change'));
            });
            // Update overall group info
            updateGroupInfo(type);
        }

        function populateShipSelects() {
            populateShipSelect(document.querySelector('.ship1'));
            populateShipSelect(document.querySelector('.ship2'));
        }

        function populateShipSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Select Ship</option>';
            shipData.forEach(ship => {
                const option = new Option(ship.Ship, ship.Ship);
                selectElement.add(option);
            });
        }

        function addShipGroup(type) {
            const container = document.getElementById(`${type}Container`);
            const newGroup = document.createElement('div');
            newGroup.className = `${type}-group ship-group mb-4`;
            newGroup.innerHTML = `
                <select class="ship${type === 'attacker' ? '1' : '2'} w-full p-2 mb-2 border rounded custom-select bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">Select ${type.charAt(0).toUpperCase() + type.slice(1)} Ship</option>
                </select>
                <input type="number" class="ship${type === 'attacker' ? '1' : '2'}Count w-full p-2 mb-2 border rounded bg-indigo-900 text-indigo-100 border-indigo-500 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" value="1" min="1" placeholder="Number of Ships">
                <div class="ship${type === 'attacker' ? '1' : '2'}Details mb-2 text-indigo-100"></div>
            `;
            container.appendChild(newGroup);
            setupShipGroup(newGroup, type);
        }

        function setupShipGroup(group, type) {
            const select = group.querySelector(`.ship${type === 'attacker' ? '1' : '2'}`);
            const countInput = group.querySelector(`.ship${type === 'attacker' ? '1' : '2'}Count`);
            const details = group.querySelector(`.ship${type === 'attacker' ? '1' : '2'}Details`);

            populateShipSelect(select);
            select.addEventListener('change', () => {
                updateShipDetails(select, details);
                updateGroupInfo(type);
            });
            countInput.addEventListener('input', () => {
                updateGroupInfo(type);
            });
        }

        function updateGroupInfo(type) {
            const groups = document.querySelectorAll(`.${type}-group`);
            let totalSupply = 0;
            let totalDPS = 0;
            let totalHP = 0;
            const shipSummaries = {};

            groups.forEach(group => {
                const ship = shipData.find(s => s.Ship === group.querySelector(`.ship${type === 'attacker' ? '1' : '2'}`).value);
                const count = parseInt(group.querySelector(`.ship${type === 'attacker' ? '1' : '2'}Count`).value) || 0;

                if (ship) {
                    totalSupply += ship.Supply * count;
                    totalDPS += (ship.Total_DPS || 0) * count;
                    totalHP += ship['Total Health'] * count;

                    if (!shipSummaries[ship.Ship]) {
                        shipSummaries[ship.Ship] = {
                            count: 0,
                            supply: 0,
                            dps: 0,
                            totalHP: 0,
                            hullHP: 0,
                            armorHP: 0,
                            shieldHP: 0,
                            effectiveArmorHP: 0
                        };
                    }

                    shipSummaries[ship.Ship].count += count;
                    shipSummaries[ship.Ship].supply += ship.Supply * count;
                    shipSummaries[ship.Ship].dps += (ship.Total_DPS || 0) * count;
                    shipSummaries[ship.Ship].totalHP += ship['Total Health'] * count;
                    shipSummaries[ship.Ship].hullHP += ship.Hull * count;
                    shipSummaries[ship.Ship].armorHP += ship.Armor * count;
                    shipSummaries[ship.Ship].shieldHP += ship.Shields * count;
                    shipSummaries[ship.Ship].effectiveArmorHP += (ship.Armor * (1 + ship.Armor_Strength / 100) - ship.Armor) * count;
                }
            });

            const container = document.getElementById(`${type}Container`);
            let groupInfoDiv = container.querySelector('.group-info');
            if (!groupInfoDiv) {
                groupInfoDiv = document.createElement('div');
                groupInfoDiv.className = 'group-info mb-4';
                container.insertBefore(groupInfoDiv, container.firstChild);
            }

            let totalCredits = 0;
            let totalMetal = 0;
            let totalCrystal = 0;

            let shipBreakdown = '';
            for (const [shipName, summary] of Object.entries(shipSummaries)) {
                const ship = shipData.find(s => s.Ship === shipName);
                const credits = ship.Credits * summary.count;
                const metal = ship.Metal * summary.count;
                const crystal = ship.Crystal * summary.count;
                const blendedCost = credits + metal * 2 + crystal * 3;

                totalCredits += credits;
                totalMetal += metal;
                totalCrystal += crystal;

                shipBreakdown += `
                    <div class="ship-summary bg-indigo-800 p-4 rounded">
                        <h4 class="font-semibold text-lg text-indigo-300 mb-2">${shipName} (x${summary.count})</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <p><strong>Supply:</strong> ${summary.supply}</p>
                            <p><strong>Total DPS:</strong> ${summary.dps.toFixed(2)}</p>
                            <p><strong>Total HP:</strong> ${summary.totalHP}</p>
                        </div>
                        <h5 class="font-semibold text-indigo-400 mt-2 mb-1">HP Breakdown:</h5>
                        <div class="grid grid-cols-2 gap-2 ml-4">
                            <p>Hull HP: ${summary.hullHP}</p>
                            <p>Armor HP: ${summary.armorHP}</p>
                            <p>Shield HP: ${summary.shieldHP}</p>
                            <p>Effective HP from Armor: ${summary.effectiveArmorHP.toFixed(2)}</p>
                        </div>
                        <h5 class="font-semibold text-indigo-400 mt-2 mb-1">Costs:</h5>
                        <div class="grid grid-cols-2 gap-2 ml-4">
                            <p>Credits: ${credits}</p>
                            <p>Metal: ${metal}</p>
                            <p>Crystal: ${crystal}</p>
                            <p>Blended Cost in Credits: ${blendedCost}</p>
                        </div>
                    </div>
                `;
            }

            const totalBlendedCost = totalCredits + totalMetal * 2 + totalCrystal * 3;

            groupInfoDiv.innerHTML = `
                <button class="collapsible bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Group Information</button>
                <div class="content bg-indigo-900 p-4 rounded-b hidden">
                    <div class="overall-summary bg-indigo-800 p-4 rounded mb-4">
                        <h3 class="font-semibold text-xl text-indigo-200 mb-2">Overall Summary</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <p><strong>Total Supply:</strong> ${totalSupply}</p>
                            <p><strong>Total DPS:</strong> ${totalDPS.toFixed(2)}</p>
                            <p><strong>Total HP:</strong> ${totalHP}</p>
                        </div>
                        <h4 class="font-semibold text-lg text-indigo-300 mt-2 mb-1">Total Costs:</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <p>Credits: ${totalCredits}</p>
                            <p>Metal: ${totalMetal}</p>
                            <p>Crystal: ${totalCrystal}</p>
                            <p>Blended Cost in Credits: ${totalBlendedCost}</p>
                        </div>
                    </div>
                    <h3 class="font-semibold text-xl text-indigo-200 mb-2">Breakdown by Ship Type</h3>
                    <div class="ship-breakdown space-y-4 max-h-96 overflow-y-auto pr-2">
                        ${shipBreakdown}
                    </div>
                </div>
            `;

            // Add event listener to the new collapsible
            const collapsible = groupInfoDiv.querySelector('.collapsible');
            collapsible.addEventListener('click', function() {
                this.classList.toggle("active");
                const content = this.nextElementSibling;
                content.classList.toggle("hidden");
            });
        }

    </script>
    <script>
        document.addEventListener('click', function(e) {
            if (e.target && e.target.className.includes('collapsible')) {
                e.target.classList.toggle("active");
                var content = e.target.nextElementSibling;
                content.classList.toggle("show");
            }
        });
    </script>
</body>
</html>
